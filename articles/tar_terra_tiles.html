<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dynamic branching with raster tiles • geotargets</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Dynamic branching with raster tiles">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">geotargets</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/geotargets.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/tar_terra_tiles.html">Dynamic branching with raster tiles</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/njtierney/geotargets/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Dynamic branching with raster tiles</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/njtierney/geotargets/blob/master/vignettes/tar_terra_tiles.Rmd" class="external-link"><code>vignettes/tar_terra_tiles.Rmd</code></a></small>
      <div class="d-none name"><code>tar_terra_tiles.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/njtierney/geotargets" class="external-link">geotargets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.8.10</span></span></code></pre></div>
<p>Computationally intensive raster operations that work in pixel-wise
manner may be handled well with <a href="https://books.ropensci.org/targets/dynamic.html#about-dynamic-branching" class="external-link">dynamic
branching</a> over tiled subsets of the raster.
<code><a href="../reference/tar_terra_tiles.html">tar_terra_tiles()</a></code> is a target factory that enables creating
these dynamic branches so downstream targets can iterate over them. This
is useful when, for example, loading an entire raster into memory and
doing computations on it results in out of memory errors.</p>
<p>In order to use <code><a href="../reference/tar_terra_tiles.html">tar_terra_tiles()</a></code>, we need to break a
raster into smaller pieces. We can do that by providing
<strong>extent</strong>s used by the raster. The concept of extent is
important, so let’s unpack that a bit more.</p>
<div class="section level2">
<h2 id="what-is-an-extent">What is an extent?<a class="anchor" aria-label="anchor" href="#what-is-an-extent"></a>
</h2>
<p>The <strong>extent</strong> describes the four points that cover the
area of a raster. The extent of a raster, <code>r</code>, is printed in
the summary:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example SpatRaster</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"ex/elev.tif"</span>, package <span class="op">=</span> <span class="st">"terra"</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="va">r</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 90, 95, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.008333333, 0.008333333  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 5.741667, 6.533333, 49.44167, 50.19167  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">#&gt; source      : elev.tif </span></span>
<span><span class="co">#&gt; name        : elevation </span></span>
<span><span class="co">#&gt; min value   :       141 </span></span>
<span><span class="co">#&gt; max value   :       547</span></span></code></pre></div>
<p>But we can get the extent with <code>ext</code>
(<strong>ext</strong>ent):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="va">r_ext</span></span>
<span><span class="co">#&gt; SpatExtent : 5.74166666666667, 6.53333333333333, 49.4416666666667, 50.1916666666667 (xmin, xmax, ymin, ymax)</span></span></code></pre></div>
<p>Which maps onto the four corners of the raster here:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># some plot helpers</span></span>
<span><span class="va">rect_extent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/rect.html" class="external-link">rect</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">plot_extents</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">rect_extent</span>, border <span class="op">=</span> <span class="st">"hotpink"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extend.html" class="external-link">extend</a></span><span class="op">(</span><span class="va">r</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">r_ext</span>, col <span class="op">=</span> <span class="st">"hotpink"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">r_ext</span>, col <span class="op">=</span> <span class="st">"hotpink"</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/unnamed-chunk-5-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Some geo-computational operations can be done independently of one
another—we want to take advantage of that, and we can facilitate this by
breaking the raster into smaller pieces, by creating new extents that
describe new subsets of the raster.</p>
<p>We can use this extent information downstream in the analysis to
describe how to break up a raster. This is similar to how we might want
to chunk up a data frame into groups to distribute to different CPU
cores. To help with this, we’ve got some helper functions.</p>
</div>
<div class="section level2">
<h2 id="helper-functions-to-create-multiple-extents-of-a-raster">Helper functions to create multiple extents of a raster<a class="anchor" aria-label="anchor" href="#helper-functions-to-create-multiple-extents-of-a-raster"></a>
</h2>
<p><code>geotargets</code> provides three helper functions that take a
<code>SpatRaster</code> and output the extents for tiles:</p>
<ul>
<li>
<code><a href="../reference/tile_helpers.html">tile_n()</a></code>,</li>
<li>
<code><a href="../reference/tile_helpers.html">tile_grid()</a></code>, and</li>
<li><code><a href="../reference/tile_helpers.html">tile_blocksize()</a></code></li>
</ul>
<p>We will demonstrate these now.</p>
<div class="section level3">
<h3 id="tile_n">
<code>tile_n()</code><a class="anchor" aria-label="anchor" href="#tile_n"></a>
</h3>
<p>We can use <code><a href="../reference/tile_helpers.html">tile_n()</a></code>, which is the simplest of the three.
It produces <em>about</em> <code>n</code> tiles in a grid.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_tile_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tile_helpers.html">tile_n</a></span><span class="op">(</span><span class="va">r</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; creating 2 * 2 = 4 tile extents</span></span>
<span><span class="va">r_tile_4</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.141667 49.816667 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  6.141667  6.533333 49.816667 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.141667 49.441667 49.816667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  6.141667  6.533333 49.441667 49.816667</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="fu">plot_extents</span><span class="op">(</span><span class="va">r_tile_4</span><span class="op">)</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/unnamed-chunk-7-1.png" width="480" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tile_helpers.html">tile_n</a></span><span class="op">(</span><span class="va">r</span>, <span class="fl">6</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">plot_extents</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; creating 2 * 3 = 6 tile extents</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/unnamed-chunk-7-2.png" width="480" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="tile_grid">
<code>tile_grid()</code><a class="anchor" aria-label="anchor" href="#tile_grid"></a>
</h3>
<p>For more control, use <code><a href="../reference/tile_helpers.html">tile_grid()</a></code>, which allows
specification of the number of rows and columns to split the raster
into. Here we are specify that we want three columns and 1 row:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_grid_3x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tile_helpers.html">tile_grid</a></span><span class="op">(</span><span class="va">r</span>, ncol <span class="op">=</span> <span class="fl">3</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r_grid_3x1</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.008333 49.441667 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  6.008333  6.266667 49.441667 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  6.266667  6.533333 49.441667 50.191667</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="fu">plot_extents</span><span class="op">(</span><span class="va">r_grid_3x1</span><span class="op">)</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/unnamed-chunk-8-1.png" width="480" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tile_helpers.html">tile_grid</a></span><span class="op">(</span><span class="va">r</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">plot_extents</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/unnamed-chunk-8-2.png" width="480" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="tile_blocksize">
<code>tile_blocksize()</code><a class="anchor" aria-label="anchor" href="#tile_blocksize"></a>
</h3>
<p>The third included helper is <code><a href="../reference/tile_helpers.html">tile_blocksize()</a></code>, which
tiles by file <strong>block size</strong>. The <strong>block
size</strong> is a property of raster files, and is the number of pixels
(in the x and y direction) that is read into memory at a time. Tiling by
multiples of block size may therefore be more efficient because only one
block should need to be loaded to create each tile target. You can find
the blocksize with <code>fileBlocksize</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/readwrite.html" class="external-link">fileBlocksize</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt;      rows cols</span></span>
<span><span class="co">#&gt; [1,]   43   95</span></span></code></pre></div>
<p>This tells us that it reads in the raster in 43x95 pixel sizes.</p>
<p>The <code>tile_blocksize</code> function is similar to
<code>tile_grid</code>, except instead of saying how many rows and
columns, we specify in units of blocksize.</p>
<p>If we just run <code><a href="../reference/tile_helpers.html">tile_blocksize()</a></code> on <code>r</code> we get
the extents of the specified blocksize:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tile_helpers.html">tile_blocksize</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.833333 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.475000 49.833333 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.441667 49.475000</span></span></code></pre></div>
<p>Which is the same as specifying blocksize for row and column at unit
1:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_block_size_1x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tile_helpers.html">tile_blocksize</a></span><span class="op">(</span><span class="va">r</span>, n_blocks_row <span class="op">=</span> <span class="fl">1</span>, n_blocks_col <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r_block_size_1x1</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.833333 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.475000 49.833333 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.441667 49.475000</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="fu">plot_extents</span><span class="op">(</span><span class="va">r_block_size_1x1</span><span class="op">)</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/unnamed-chunk-11-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Here the block size is the same size for the first two blocks, and
then a much more narrow block. This is different to the two other tile
methods.</p>
<p>Here the column block size is the full width of the raster.</p>
<p>So we could instead have the blocksize extent be written out to 2
blocks in a row, and 1 block size for the columns:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_block_size_2x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tile_helpers.html">tile_blocksize</a></span><span class="op">(</span><span class="va">r</span>, n_blocks_row <span class="op">=</span> <span class="fl">2</span>, n_blocks_col <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">r_block_size_2x1</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.475000 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.533333 49.441667 49.475000</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="fu">plot_extents</span><span class="op">(</span><span class="va">r_block_size_2x1</span><span class="op">)</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/unnamed-chunk-12-1.png" width="480" style="display: block; margin: auto;"></p>
<p>This only works when the <code>SpatRaster</code> points to a
file—in-memory rasters have no inherent block size.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sources.html" class="external-link">sources</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/terra/ex/elev.tif"</span></span>
<span><span class="co"># force into memory</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">+</span> <span class="fl">0</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sources.html" class="external-link">sources</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span><span class="co"># this now errors</span></span>
<span><span class="fu"><a href="../reference/tile_helpers.html">tile_blocksize</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: [aggregate] values in argument 'fact' should be &gt; 0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-targets-pipeline">Example targets pipeline<a class="anchor" aria-label="anchor" href="#example-targets-pipeline"></a>
</h2>
<p>When developing a <code>targets</code> pipeline using
<code><a href="../reference/tar_terra_tiles.html">tar_terra_tiles()</a></code> with <code><a href="../reference/tile_helpers.html">tile_blocksize()</a></code>, it’s
a good idea to figure out how many tiles <code><a href="../reference/tile_helpers.html">tile_blocksize()</a></code>
will create before implementing <code><a href="../reference/tar_terra_tiles.html">tar_terra_tiles()</a></code>. We’ll
start by making a bigger raster to experiment with using
<code><a href="https://rspatial.github.io/terra/reference/disaggregate.html" class="external-link">terra::disagg()</a></code>, (which makes a higher resolution raster by
breaking the pixels into smaller pixels), and making multiple
layers.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># contents of _targets.R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/njtierney/geotargets" class="external-link">geotargets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/geotargets-options.html">geotargets_option_set</a></span><span class="op">(</span>gdal_raster_driver <span class="op">=</span> <span class="st">"COG"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html" class="external-link">tar_target</a></span><span class="op">(</span></span>
<span>    <span class="va">raster_file</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"ex/elev.tif"</span>, package <span class="op">=</span> <span class="st">"terra"</span><span class="op">)</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"file"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/tar_terra_rast.html">tar_terra_rast</a></span><span class="op">(</span></span>
<span>    <span class="va">r</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/disaggregate.html" class="external-link">disagg</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">raster_file</span><span class="op">)</span>, fact <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># add more layers</span></span>
<span>  <span class="fu"><a href="../reference/tar_terra_rast.html">tar_terra_rast</a></span><span class="op">(</span></span>
<span>    <span class="va">r_big</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">r</span> <span class="op">+</span> <span class="fl">100</span>, <span class="va">r</span> <span class="op">*</span> <span class="fl">10</span>, <span class="va">r</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    memory <span class="op">=</span> <span class="st">"transient"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">tar_make</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">terra 1.8.10</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched target raster_file</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed target raster_file [0 seconds, 7.994 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched target r</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed target r [0.01 seconds, 822.781 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched target r_big</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed target r_big [0.023 seconds, 4.055 megabytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ ended pipeline [0.428 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_load.html" class="external-link">tar_load</a></span><span class="op">(</span><span class="va">r_big</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tile_helpers.html">tile_blocksize</a></span><span class="op">(</span><span class="va">r_big</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.168333 49.765000 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  6.168333  6.533333 49.765000 50.191667 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  5.741667  6.168333 49.441667 49.765000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt;      xmin      xmax      ymin      ymax </span></span>
<span><span class="co">#&gt;  6.168333  6.533333 49.441667 49.765000</span></span></code></pre></div>
<p>Four tiles is reasonable, so we’ll go with that. Note that we have to
ensure the <code>r_big</code> target is not in-memory for
<code><a href="../reference/tar_terra_tiles.html">tar_terra_tiles()</a></code>, so we set the targets option
<code>memory = "transient"</code>. See the <a href="https://docs.ropensci.org/targets/reference/tar_target.html#arg-memory" class="external-link">targets
documentation on memory</a> for details.</p>
<p>The process that happens from here can be thought of as
<code>split-apply-combine</code>.</p>
<ul>
<li>
<strong>Split</strong> the raster into pieces using the
<code><a href="../reference/tar_terra_tiles.html">tar_terra_tiles()</a></code> target factory
<ul>
<li>This returns tiles whose <strong>extents</strong> are created by one
of the tile functions described above (<code><a href="../reference/tile_helpers.html">tile_n()</a></code>,
<code><a href="../reference/tile_helpers.html">tile_grid()</a></code>, or <code><a href="../reference/tile_helpers.html">tile_blocksize()</a></code>), supplying
this to <code>tile_fun</code>.</li>
</ul>
</li>
<li>
<strong>Apply</strong> a function to the rasters.
<ul>
<li>This can be any function that would work on a raster, in the case
below we use the <code>app</code> function from <code>terra</code>,
which applies some function to the cells of a raster.</li>
<li>To do this we use <code><a href="../reference/tar_terra_rast.html">tar_terra_rast()</a></code> and then supply the
<code>pattern = map(tiles)</code>, where <code>tiles</code> is the name
of the target created with <code><a href="../reference/tar_terra_tiles.html">tar_terra_tiles()</a></code>. You can think
of <code>pattern = map(tiles)</code> as saying: “Do the task for each of
the tiles we have specified and return them as a list”</li>
</ul>
</li>
<li>
<strong>Combine</strong> the list of rasters together.
<ul>
<li>In this case we use <code><a href="../reference/tar_terra_rast.html">tar_terra_rast()</a></code> and use
<code><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge()</a></code> on the tiles.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># contents of _targets.R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/njtierney/geotargets" class="external-link">geotargets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/geotargets-options.html">geotargets_option_set</a></span><span class="op">(</span>gdal_raster_driver <span class="op">=</span> <span class="st">"COG"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_option_set.html" class="external-link">tar_option_set</a></span><span class="op">(</span>memory <span class="op">=</span> <span class="st">"transient"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html" class="external-link">tar_target</a></span><span class="op">(</span></span>
<span>    <span class="va">raster_file</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"ex/elev.tif"</span>, package <span class="op">=</span> <span class="st">"terra"</span><span class="op">)</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"file"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/tar_terra_rast.html">tar_terra_rast</a></span><span class="op">(</span></span>
<span>    <span class="va">r</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/disaggregate.html" class="external-link">disagg</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">raster_file</span><span class="op">)</span>, fact <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/tar_terra_rast.html">tar_terra_rast</a></span><span class="op">(</span></span>
<span>    <span class="va">r_big</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">r</span> <span class="op">+</span> <span class="fl">100</span>, <span class="va">r</span> <span class="op">*</span> <span class="fl">10</span>, <span class="va">r</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    memory <span class="op">=</span> <span class="st">"transient"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/tar_terra_tiles.html">tar_terra_tiles</a></span><span class="op">(</span></span>
<span>    <span class="va">tiles</span>,</span>
<span>    raster <span class="op">=</span> <span class="va">r_big</span>,</span>
<span>    tile_fun <span class="op">=</span> <span class="va">tile_blocksize</span>,</span>
<span>    description <span class="op">=</span> <span class="st">"split raster into tiles"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/tar_terra_rast.html">tar_terra_rast</a></span><span class="op">(</span></span>
<span>    <span class="va">tiles_mean</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span><span class="va">tiles</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">tiles</span><span class="op">)</span>,</span>
<span>    description <span class="op">=</span> <span class="st">"some computationaly intensive task performed on each tile"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/tar_terra_rast.html">tar_terra_rast</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_mean</span>,</span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sprc.html" class="external-link">sprc</a></span><span class="op">(</span><span class="va">tiles_mean</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    description <span class="op">=</span> <span class="st">"merge tiles into a single SpatRaster"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">tar_make</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">terra 1.8.10</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ✔ skipping targets (1 so far)...</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched target tiles_exts</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed target tiles_exts [0.005 seconds, 153 bytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_11882e184aa27102</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_11882e184aa27102 [0.003 seconds, 982.55 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_e39b1bcab4d45ba0</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_e39b1bcab4d45ba0 [0.036 seconds, 249.778 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_b14b762418a51f63</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_b14b762418a51f63 [0.002 seconds, 599.615 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_bfb55de5c880456f</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_bfb55de5c880456f [0.002 seconds, 483.702 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed pattern tiles </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_mean_1bcefdb80d0879e0</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_mean_1bcefdb80d0879e0 [2.14 seconds, 159.194 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_mean_4ff32c943e05dc36</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_mean_4ff32c943e05dc36 [1.861 seconds, 49.028 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_mean_17723520c935f474</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_mean_17723520c935f474 [1.6 seconds, 100.948 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched branch tiles_mean_984998bf0804c2cf</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed branch tiles_mean_984998bf0804c2cf [1.43 seconds, 87.272 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed pattern tiles_mean </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ dispatched target merged_mean</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ● completed target merged_mean [0.015 seconds, 879.912 kilobytes]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; ▶ ended pipeline [7.584 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<p>We can see from <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">tar_make()</a></code> output above and the plots
below that <code>tiles</code> and <code>tiles_mean</code> are both
patterns with four branches each.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_load.html" class="external-link">tar_load</a></span><span class="op">(</span><span class="va">tiles_mean</span><span class="op">)</span></span>
<span><span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">tiles_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tiles_mean</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/tiled-plot-1.png" width="480" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span></span></code></pre></div>
<p>And combined, they make the full plot again.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html" class="external-link">tar_read</a></span><span class="op">(</span><span class="va">merged_mean</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="tar_terra_tiles_files/figure-html/merged-plot-1.png" width="480" style="display: block; margin: auto;"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicholas Tierney, Eric Scott, Andrew Brown.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
